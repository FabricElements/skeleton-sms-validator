<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-input/paper-textarea.html">

<dom-module id="skeleton-sms-validator">
  <template>
    <style>
      :host {
        display: block;
      }

      paper-textarea[invalid]:focus {
        --paper-input-container-input: {
          outline: red;
        } 
      }

      .char-counter {
        display: flex;
        justify-content: flex-end;
        color: var(--paper-indigo-900)
      }

      .char-counter p {
        margin: 0;
      }
    </style>
    
    <paper-textarea label="Enter message"
                    value="{{text}}"
                    invalid$="[[invalid]]"></paper-textarea>
    <div class="char-counter">
      <p>[[charCounter]] / [[limit]]</p>
    </div>
  </template>

  <script src="./encoder-utils.js"></script>

  <script>
    /**
     * `skeleton-sms-validator`
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class SkeletonSmsValidator extends Polymer.Element {
      /**
       * @return {string}
      */
      static get is() {
        return 'skeleton-sms-validator';
      }

      /**
       * @return {object}
      */
      static get properties() {
        return {
          type: {
            type: String,
            value: null,
            reflectToAttribute: true,
            notify: true,
          },
          segments: {
            type: Array,
            value: [],
            reflectToAttribute: true,
            notify: true,
            observer: '_segmentsObserver',
          },
          invalid: {
            type: Boolean,
            value: false,
            reflectToAttribute: true,
            notify: true,
          },
          text: {
            type: String,
            value: null,
            notify: true,
            reflectToAttribute: true,
            observer: '_textObserver',
          },
          data: {
            type: String,
            value: null,
            reflectToAttribute: true,
            notify: true,
          },
          limit: {
            type: Number,
            value: null,
          },
          segmentsQty: {
            type: Number,
            value: 2,
          },
          charCounter: {
            type: Array,
            value: [],
          },
        };
      }

      /**
       * Observers
       *
       * @return {array}
       */
       static get observers() {
        return [
          // Observer method name, followed by a list of dependencies in
          // parenthesis
          '_messagesObserver(segments, type, segmentsQty)',
        ];
      }

      /**
       * Text Observer
       *
       * @param {string} text
       * @private
      */
      _textObserver(text) {
        if (!text) return;

        const inputChars = encoderUtils.unicodeCharacters(text);

        this.type = encoderUtils.pickencoding(inputChars);

        const segments = this.type === 'gsm'
          ? encoderUtils._segmentWith(
            160,
            153,
            encoderUtils.encodeCharGsm)(inputChars)
          : encoderUtils._segmentWith(
            140,
            134,
            encoderUtils.encodeCharUtf16)(inputChars);

        this.segments = segments.map((s) => s.bytes);

        this.invalid = this.segments.length > this.segmentsQty;

        if (!this.invalid) {
          this.data = text;
        } else {
          this.data = null;
        }
      }

      /**
       * Text Observer
       *
       * @private
       */
      _segmentsObserver() {
        if (!this.segments) return;

        const totalChars = this.segments
          .map((arr) => arr.reduce((acc, b) => acc + b.length, 0))
          .reduce((acc, b) => acc + b, 0);

        this.charCounter = totalChars;
      }

      /**
       * Messages Observer
       *
       * @param {Array} segments
       * @param {string} type
       * @param {number} segmentsQty
       * @private
       */
      _messagesObserver(segments, type, segmentsQty) {
        if (!type) return;

        if (type === 'gsm') {
          if (segments.length <= 1) {
            this.limit = 160 * segmentsQty;
          } else {
            this.limit = 153 * segmentsQty;
          }
        } else {
          if (segments.length <= 1) {
            this.limit = 140 * segmentsQty;
          } else {
            this.limit = 134 * segmentsQty;
          }
        }
      }
    }

    window.customElements.define(SkeletonSmsValidator.is, SkeletonSmsValidator);
  </script>
</dom-module>
