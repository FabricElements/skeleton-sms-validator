<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-input/paper-textarea.html">

<dom-module id="skeleton-sms-validator">
  <template>
    <style>
      :host {
        display: block;
      }

      paper-textarea[invalid]:focus {
        --paper-input-container-input: {
          outline: red;
        } 
      }

      .char-counter {
        display: flex;
        justify-content: flex-end;
        color: var(--paper-indigo-900)
      }

      .char-counter p {
        margin: 0;
      }

      .character {
        border-radius: 3px;
        border: 1px solid white;
        color: white;
        display: inline-block;
        font-size: 14px;
        height: 1.5em;
        line-height: 1.5;
        text-align: center;
        vertical-align: top;
        width: 1.5em;
      }

      .character.gsm {
        background-color: var(--paper-blue-200);
      }

      .character.gsm.double-char {
        background-color: var(--paper-orange-300);
      }

      .character.ucs2 {
        background-color: var(--paper-red-400);
      }
    </style>
    
    <paper-textarea label="Enter message"
                    value="{{text}}"
                    invalid$="[[invalid]]"></paper-textarea>
    <div class="char-counter">
      <p>[[charCounter]] / [[limit]]</p>
    </div>
    <div class="message">
      <p class="message-data"></p>
      <h4>LEGEND</h4>
      <table>
        <tbody>
          <tr>
            <td>
              <span class="character gsm"></span>
            </td>
            <td>Regular GSM character</td>
          </tr>
          <tr>
            <td>
              <span class="character gsm double-char"></span>
            </td>
            <td>GSM character that can be used for the cost of two characters</td>
          </tr>
          <tr>
            <td>
              <span class="character ucs2"></span>
            </td>
            <td>Character not present in GSM charset, forces to use UCS2 encoding</td>
          </tr>
        </tbody>
      </table>
    </div>
  </template>

  <script src="./encoder-utils.js"></script>

  <script>
    /**
     * `skeleton-sms-validator`
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class SkeletonSmsValidator extends Polymer.Element {
      /**
       * @return {string}
      */
      static get is() {
        return 'skeleton-sms-validator';
      }

      /**
       * @return {object}
      */
      static get properties() {
        return {
          type: {
            type: String,
            value: null,
            reflectToAttribute: true,
            notify: true,
          },
          segments: {
            type: Array,
            value: [],
            reflectToAttribute: true,
            notify: true,
            observer: '_segmentsObserver',
          },
          invalid: {
            type: Boolean,
            value: false,
            reflectToAttribute: true,
            notify: true,
          },
          text: {
            type: String,
            value: null,
            notify: true,
            reflectToAttribute: true,
            observer: '_textObserver',
          },
          data: {
            type: String,
            value: null,
            reflectToAttribute: true,
            notify: true,
          },
          limit: {
            type: Number,
            value: null,
          },
          segmentsQty: {
            type: Number,
            value: 2,
          },
          charCounter: {
            type: Array,
            value: [],
          },
        };
      }

      /**
       * Observers
       *
       * @return {array}
       */
       static get observers() {
        return [
          // Observer method name, followed by a list of dependencies in
          // parenthesis
          '_messagesObserver(segments, type, segmentsQty)',
          '_charsObserver(text)',
        ];
      }

      /**
       * Text Observer
       *
       * @param {string} text
       * @private
      */
      _textObserver(text) {
        if (!text) return;

        const inputChars = encoderUtils.unicodeCharacters(text);

        this.type = encoderUtils.pickencoding(inputChars);

        const segments = this.type === 'gsm'
          ? encoderUtils._segmentWith(
            160,
            153,
            encoderUtils.encodeCharGsm)(inputChars)
          : encoderUtils._segmentWith(
            140,
            134,
            encoderUtils.encodeCharUtf16)(inputChars);

        this.segments = segments.map((s) => s.bytes);

        this.invalid = this.segments.length > this.segmentsQty;

        if (!this.invalid) {
          this.data = text;
        } else {
          this.data = null;
        }
      }

      /**
       * Segments Observer
       *
       * @private
       */
      _segmentsObserver() {
        if (!this.segments) return;

        const totalChars = this.segments
          .map((arr) => arr.reduce((acc, b) => acc + b.length, 0))
          .reduce((acc, b) => acc + b, 0);

        this.charCounter = totalChars;
      }

      /**
       * Messages Observer
       *
       * @param {Array} segments
       * @param {string} type
       * @param {number} segmentsQty
       * @private
       */
      _messagesObserver(segments, type, segmentsQty) {
        if (!type) return;

        if (type === 'gsm') {
          if (segments.length <= 1) {
            this.limit = 160 * segmentsQty;
          } else {
            this.limit = 153 * segmentsQty;
          }
        } else {
          if (segments.length <= 1) {
            this.limit = 140 * segmentsQty;
          } else {
            this.limit = 134 * segmentsQty;
          }
        }
      }

      /**
       * Chars Observer
       *
       * @param {string} text
       * @private
       */
       _charsObserver(text) {
        if (!text) return;

        const charData = this.shadowRoot.querySelector('.message-data');
        const fragment = document.createDocumentFragment();

        encoderUtils.unicodeCodePoints(text).map((char) => {
          const span = document.createElement('span');

          span.textContent = String.fromCodePoint(char);

          span.classList.add('character');
          if (char in unicodeToGsm) {
            span.classList.add('gsm');
            if (unicodeToGsm[char].length > 1) {
              span.classList.add('double-char');
            }
          } else {
            span.classList.add('ucs2');
          }

          return span;
        }).reduce((acc, span) => {
          acc.appendChild(span);
          return acc;
        }, fragment);

        charData.innerHTML = '';
        charData.appendChild(fragment);
      }
    }

    window.customElements.define(SkeletonSmsValidator.is, SkeletonSmsValidator);
  </script>
</dom-module>
